# SlopChop v1.4.0: Agentic Stage & Nuclear Sync

**Status:** IMPLEMENTED (2026-01-05)  
**Goal:** Enable a zero-friction, direct-edit workflow for AI Agents using a safe staging sandbox.

## 1. The Core Workflow (The "Loop") [DONE]
The user (Blind Master) provides high-level intent. The Agent performs the work in a isolated sandbox.
1.  **Init:** `slopchop stage` creates the sandbox.
2.  **Edit:** Agent edits files in `.slopchop/stage/worktree/`.
3.  **Check:** Agent runs `slopchop check` to verify against the "3 Laws."
4.  **Sync:** Agent runs `slopchop apply --sync` to promote changes to the real repo.

---

## 2. Feature A: The `stage` Command [DONE]
This is the "Front Door" for the agent. It prepares the shadow worktree.

*   **Behavior:** [COMPLETED]
    1.  Check if `.slopchop/stage/worktree` exists.
    2.  If it exists: Prompt "Existing stage will be wiped. Proceed? [y/N]". (Supports `--force` to skip).
    3.  Execution: Run `stage.reset()` followed by `stage.create_stage()`.
    4.  Result: A fresh copy of the repository is mirrored into the stage, ready for direct editing.

---

## 3. Feature B: The "Nuclear Sync" (`apply --sync`) [DONE]
This is the "Back Door." It mirrors the sandbox to the real workspace.

*   **Mechanism:** `src/stage/sync.rs` [IMPLEMENTED]
*   **Logic:** [COMPLETED]
    1.  **Mirror:** Overwrite all files in root `./` with their versions from `.slopchop/stage/worktree/`.
    2.  **Prune:** Delete files in root that do not exist in the stage.
*   **Infrastructure Protection (Critical Exclusions):** [HARDENED]
    Never delete or overwrite: `.git/`, `.slopchop/`, `target/`, `node_modules/`, `.env`, `.vscode/`, `.idea/`.
*   **Self-Destruct:** After a successful sync, automatically run `reset()` on the stage.

---

## 4. Feature C: Heuristic Nudging (The "Nag") [DONE]
Enforce "Iterative Discipline" via terminal feedback during the `check` command.

*   **Modification Detection:** Inside `handle_check`, if a stage exists, check `state.json` via `StageManager`. [COMPLETED]
*   **Threshold:** If modified files > 3. [CONFIGURED]
*   **Action:** Print a prominent [ADVISORY] block at the end of the `check` output suggesting the AI wrap up and sync to maintain high-integrity.

---

## 5. Feature D: Snapshot Documentation Protocol [DONE/ARCHIVED]
The project now uses a "Snapshot" model for history to minimize AI context bloat.

*   **Canonical Docs:** Updated `past-present-future.md`. [STABLE]
*   **Archive:** Moved previous version notes to `docs/archived/v1.3.5/`. [DONE]
*   **Exclusion:** `.slopchopignore` updated. [DONE]
*   **Literate Code:** Feature descriptions integrated into module/function level docstrings. [DONE]

---

## 6. Implementation Record (Historical Context for Future Agents)
- **Modularization:** Discovered that `handlers.rs` was nearing token limits. Extracted `src/cli/stage_handlers.rs` during v1.4.0 implementation.
- **Verification:** Verified with `slopchop check` which runs clippy, tests, and structural scan. 
- **Safety Polish:** `sync.rs` uses `std::cmp::Reverse` for depth-first directory cleanup to ensure parents are removed after children.

---

### End of Specification. 
**Status:** This specification is now the historical record for v1.4.0. Current operational state is tracked in `docs/past-present-future.md`.
